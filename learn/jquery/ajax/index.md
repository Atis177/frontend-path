# jQuery Ajax
Объект `XMLHttpRequest` позволяет браузеру обращаться к серверу без перезагрузки страницы. Посылается асинхронный запрос
на URL, сервер отдает данные, котоыре можно обработать в коллбэк-функции. Асинхронный — значит не блокирующий. То 
есть остальной код может продолжать исполняться во время выполнения запроса. Асинхронные запросы требуют времени на 
выполнение и могут быть обработаны не сразу. Для этого используются коллбэки и некоторые другие штуки.

Так работать не будет:

```js
    var response;
     
    $.get( "foo.php", function( r ) {
        response = r;
    });
     
    console.log( response ); // undefined
```

А так будет:

```js
    $.get( "foo.php", function( response ) {
        console.log( response ); // server response
    });
```

Ajax — Asynchronous JavaScript and XML. Однако, XML тут по историческим причинам. В основном обмен данными происходит
в формате [JSON][2] или просто HTML.

## Обработка событий после аякса
Нужно помнить, что обработчики событий на элементах, которые добавляются/заменяются аяксом не сработают. Для этого нужно использовать делегирование от родительского контейнера, который аяксом не обновляется.

## Синтаксис
```js
$.ajax({
    url: "post.php",
    // ...
}).done(function (json) {
    // Все ок. Показываем ответ сервера:
    $("<h1>").text(json.title).appendTo("body");
    $("<div class=\"content\">").html(json.html).appendTo("body");
}).fail(function (xhr, status, errorThrown) {
    // Показали ошибку, если сервер не ответил и вывели техническую информация в консоль:
    alert("Извините, произошла ошибка. Пожалуйста, обновите страницу и попробуйте еще раз.");
    console.log("Error: " + errorThrown);
    console.log("Status: " + status);
    console.dir(xhr);
}).always(function (xhr, status) {
    $.fancybox.hideLoading(); // Убрали крутилку в любом случае.
});
```

## Кроссдоменные запросы
Раньше браузеры не позволяли посылать ajax-запросы на другие домены. Обходной путь — JSONP, в нем обмен данными идет через тег `<script>`. Так же современные браузеры используют [Cross-Origin Resource Sharing (CORS)][1]. Для этого нужно включить на сервере соответствующие настройки.

Чтобы аякс-запрос обработался, клиент и сервер должны быть на одном домене, использовать одни и тот же протокол 
(http/https) и общаться по одному и тому же порту. Это ограничение не распространяется на скрпты, загружаемые через 
аяксовые методы jQuery.

JSNP обходит эти ограничения, релазиуя передачу данных, которые будут записаны в тег `<script>`. Сервер возвращает 
скрипт, который будет обернут в коллбэк-функцию, которую мы ему назовем.

[1] http://caniuse.com/#search=CORS
[2] http://json.org/json-ru.html

## Основные понятия
### GET и POST
`GET`-запрос нужен для получения данных. Не для изменения или удаления, а просто для того, чтобы что-то узнать. Такие
запросы кешируются браузерами и посылаются как параметры в адресной строке браузера.
Например, `https://www.google.ru/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=json`

`POST`-запросы используются для изменения данных на сервере: добавить пользователя, удалить товар, изменить пароль и пр. Такие запросы браузер не кеширует и данные не видны в адресной строке.

### Типы данных
Данные могут быть получены в разном виде:

* text — обычные строковые данные
* html — блоки html-кода
* script — для добавления нового тега script на страницу
* JSON — передача строк, массивов и объектов
* JSONP — JSON с другого домена
* XML

В основном используется JSON.

## Методы для работы с аяксом
Основной функционал в jQuery реализует метод `$.ajax`. Остальные методы — шорткаты.

В работе нужно использовать `$.ajax` для любых запросов. Для консистентности кода (читабельность, привычность), для обработки ошибок и задания параметров. В подавляющем большинстве случаев `$.post` и `$.get` использовать недостаточно.

## Работа с формами
## Сериализация
`serialize()` — представляет данные формы в виде строки запроса (query string). Каждый элемент формы должен иметь 
атрибут `name`. Значения инпутов `checkbox` и `radio` добавятся только если они отмечены.

```js
// Turning form data into a query string
$( "#myForm" ).serialize();
 
// Creates a query string like this:
// field_1=something&field2=somethingElse
```

`serializeArray` — представляет данные формы в виде массива объектов:

```js
// Creating an array of objects containing form data
$( "#myForm" ).serializeArray();
 
// Creates a structure like this:
// [
//   {
//     name : "field_1",
//     value : "something"
//   },
//   {
//     name : "field_2",
//     value : "somethingElse"
//   }
// ]
```

## Валидация

## Префильтер

## JSONP
Создается тег скрипт, в src добавляется нужный URL. Начинается загрузка. Сервер отдает данные, обернутые в 
функцию-коллбэк. Название функции заранее оговорено, все о нем знают. Клиент полностью доверяет серверу:

```js
// Добавляем скрипт
addScript('user?id=123&callback=onUserData'); // функция сгенерирует <script src="user?id=..."> и добавить в head
// ответ сервера
onUserData({
  name: "Вася",
  age: 25
});
```

## Материалы
* https://learn.jquery.com/ajax/
* http://learn.javascript.ru/json
* http://learn.javascript.ru/ajax-jsonp
* http://api.jquery.com/category/ajax/
* http://www.html5rocks.com/en/tutorials/cors/
